#!/bin/bash

# Godot Game Framework Example - Central management script (ggfe)
# Mirrors the framework's `ggf` commands (install/lint/format) for this example repo.

GODOT_URL="https://downloads.godotengine.org/?version=4.5.1&flavor=stable&slug=linux.x86_64.zip&platform=linux.64"
GODOT_DIR="godot"
TEMP_ZIP="/tmp/godot_linux.zip"

if [ -t 1 ] && command -v tput > /dev/null 2>&1; then
    RED=$(tput setaf 1)
    GREEN=$(tput setaf 2)
    YELLOW=$(tput setaf 3)
    BLUE=$(tput setaf 4)
    BOLD=$(tput bold)
    NC=$(tput sgr0)
else
    RED=''; GREEN=''; YELLOW=''; BLUE=''; BOLD=''; NC=''
fi

show_help() {
    echo "${BLUE}Godot Game Framework Example (ggfe)${NC}"
    echo
    echo "${GREEN}Usage:${NC}"
    echo "    ggfe <command> [options]"
    echo
    echo "${GREEN}Commands:${NC}"
    echo "    ${YELLOW}install${NC}           Download and install Godot engine"
    echo "    ${YELLOW}lint${NC}              Lint GDScript (gdlint) for example + framework submodule"
    echo "    ${YELLOW}format [--check]${NC}  Format GDScript (gdformat) for example + framework submodule"
    echo "    ${YELLOW}help${NC}              Show this help message"
    echo
    echo "${GREEN}Lint/format options:${NC}"
    echo "    ${YELLOW}--check${NC}           For format: do not write changes; exit non-zero if changes needed"
    echo "    ${YELLOW}--diff${NC}            For format --check: print unified diff"
}

# Try to activate a local virtual environment if commands are not found
try_activate_venv() {
    # Check if we've already tried to activate (to avoid infinite loops)
    if [ -n "${GGFE_VENV_ACTIVATED:-}" ]; then
        return 1
    fi
    
    # Look for .venv or venv directories in current dir and up to 3 parent levels
    local search_dir="$PWD"
    local max_depth=3
    local depth=0
    
    while [ $depth -le $max_depth ]; do
        for venv_dir in ".venv" "venv"; do
            local venv_path="$search_dir/$venv_dir"
            if [ -f "$venv_path/bin/activate" ]; then
                echo "${BLUE}Activating virtual environment: $venv_path${NC}" >&2
                # Source the activation script
                # shellcheck disable=SC1091
                . "$venv_path/bin/activate"
                export GGFE_VENV_ACTIVATED=1
                return 0
            fi
        done
        
        # Move up one directory
        local parent_dir
        parent_dir="$(dirname "$search_dir")"
        
        # Stop if we've reached the root or can't go further up
        if [ "$parent_dir" = "$search_dir" ] || [ "$parent_dir" = "/" ]; then
            break
        fi
        
        search_dir="$parent_dir"
        depth=$((depth + 1))
    done
    
    return 1
}

ensure_dev_requirements() {
    # Installs Python dev requirements (gdtoolkit, etc.) into a local venv.
    local req_file="requirements-dev.txt"
    if [ ! -f "$req_file" ]; then
        echo "${RED}Error: $req_file not found.${NC}"
        return 1
    fi

    # Prefer activating an existing venv (in this dir or parents).
    if [ -z "${VIRTUAL_ENV:-}" ] && [ -z "${GGFE_VENV_ACTIVATED:-}" ]; then
        try_activate_venv || true
    fi

    # If no venv is active, create a local .venv.
    if [ -z "${VIRTUAL_ENV:-}" ]; then
        local py=""
        if command -v python3 > /dev/null 2>&1; then
            py="python3"
        elif command -v python > /dev/null 2>&1; then
            py="python"
        else
            echo "${RED}Error: python3/python not found. Cannot install dev tools.${NC}"
            return 1
        fi

        if [ ! -f ".venv/bin/activate" ]; then
            echo "${BLUE}Creating virtual environment: .venv${NC}" >&2
            "$py" -m venv .venv || return 1
        fi

        echo "${BLUE}Activating virtual environment: .venv${NC}" >&2
        # shellcheck disable=SC1091
        . ".venv/bin/activate"
        export GGFE_VENV_ACTIVATED=1
    fi

    if ! command -v python > /dev/null 2>&1; then
        echo "${RED}Error: python not found in the active environment.${NC}"
        return 1
    fi
    if ! python -m pip --version > /dev/null 2>&1; then
        echo "${RED}Error: pip not available in the active environment.${NC}"
        return 1
    fi

    echo "${BLUE}Installing dev tools from ${YELLOW}${req_file}${NC}${BLUE}...${NC}" >&2
    python -m pip install -r "$req_file" || return 1
    return 0
}

require_command() {
    local cmd="$1"
    local human_name="$2"
    
    if command -v "$cmd" > /dev/null 2>&1; then
        return 0
    fi
    if [ -x ".venv/bin/$cmd" ]; then
        return 0
    fi
    
    # Try to activate venv if not already done
    if [ -z "${GGFE_VENV_ACTIVATED:-}" ]; then
        if try_activate_venv; then
            # Check again after activation
            if command -v "$cmd" > /dev/null 2>&1; then
                return 0
            fi
        fi
    fi

    # Auto-install Python dev requirements for common tooling (lint/format) when missing.
    if [ "$cmd" = "gdlint" ] || [ "$cmd" = "gdformat" ]; then
        if ensure_dev_requirements; then
            if command -v "$cmd" > /dev/null 2>&1 || [ -x ".venv/bin/$cmd" ]; then
                return 0
            fi
        fi
    fi
    
    echo "${RED}Error: '$cmd' not found.${NC}"
    echo "${YELLOW}Install ${human_name} locally to use this command.${NC}"
    echo "${YELLOW}Tip: pip install -r requirements-dev.txt${NC}"
    return 1
}

resolve_command() {
    local cmd="$1"
    
    if command -v "$cmd" > /dev/null 2>&1; then
        command -v "$cmd"
        return 0
    fi
    if [ -x ".venv/bin/$cmd" ]; then
        echo ".venv/bin/$cmd"
        return 0
    fi
    
    # If command still not found and venv not activated, try activating
    if [ -z "${GGFE_VENV_ACTIVATED:-}" ]; then
        if try_activate_venv; then
            if command -v "$cmd" > /dev/null 2>&1; then
                command -v "$cmd"
                return 0
            fi
        fi
    fi
    
    return 1
}

find_godot_executable() {
    if [ -f "$GODOT_DIR/Godot_v4.5.1-stable_linux.x86_64" ]; then
        echo "$GODOT_DIR/Godot_v4.5.1-stable_linux.x86_64"
        return 0
    fi
    local executable
    executable=$(find "$GODOT_DIR" -type f -name "Godot*" -executable 2>/dev/null | head -n 1 || true)
    if [ -n "$executable" ]; then
        echo "$executable"
        return 0
    fi
    if command -v godot > /dev/null 2>&1; then
        echo "godot"
        return 0
    fi
    return 1
}

cmd_install() {
    set -e
    echo "${BLUE}Installing Godot 4.5.1...${NC}"
    mkdir -p "$GODOT_DIR"

    if [ -f "$GODOT_DIR/Godot"* ] || [ -f "$GODOT_DIR/godot"* ]; then
        echo "${YELLOW}Godot appears to already be installed in $GODOT_DIR/${NC}"
        echo "${YELLOW}Remove it if you want to reinstall.${NC}"
        exit 0
    fi

    echo "${BLUE}Downloading Godot 4.5.1...${NC}"
    require_command "curl" "curl" || exit 1
    require_command "unzip" "unzip" || exit 1

    curl -L -o "$TEMP_ZIP" "$GODOT_URL"
    echo "${BLUE}Extracting Godot...${NC}"
    unzip -q "$TEMP_ZIP" -d "$GODOT_DIR"
    rm -f "$TEMP_ZIP"

    local exe
    exe=$(find_godot_executable) || true
    if [ -z "$exe" ]; then
        echo "${RED}Error: Could not find Godot executable after extraction${NC}"
        exit 1
    fi
    chmod +x "$exe" 2>/dev/null || true

    echo "${GREEN}âœ“ Godot installed: ${YELLOW}${exe}${NC}"
}

cmd_lint() {
    echo "${BLUE}Linting GDScript...${NC}"
    require_command "gdlint" "gdtoolkit" || exit 1

    local GDLINT
    GDLINT="$(resolve_command gdlint)"

    echo "${BLUE}Linting example project code...${NC}"
    "$GDLINT" src ui scenes resources
    
    echo "${BLUE}Linting framework addon code...${NC}"
    "$GDLINT" addons/godot_game_framework
}

cmd_format() {
    local CHECK=false
    local DIFF=false

    while [[ $# -gt 0 ]]; do
        case $1 in
            --check) CHECK=true; shift ;;
            --diff) DIFF=true; shift ;;
            *) echo "${YELLOW}Unknown option: $1${NC}"; shift ;;
        esac
    done

    echo "${BLUE}Formatting GDScript...${NC}"
    require_command "gdformat" "gdtoolkit" || exit 1
    local GDFORMAT
    GDFORMAT="$(resolve_command gdformat)"

    local TARGETS=(src ui scenes resources addons/godot_game_framework)

    if [ "$CHECK" = true ]; then
        if [ "$DIFF" = true ]; then
            "$GDFORMAT" --check --diff "${TARGETS[@]}"
        else
            "$GDFORMAT" --check "${TARGETS[@]}"
        fi
    else
        "$GDFORMAT" "${TARGETS[@]}"
    fi
}

main() {
    if [ $# -eq 0 ]; then
        show_help
        exit 0
    fi

    local COMMAND="$1"
    shift
    case "$COMMAND" in
        install) cmd_install "$@" ;;
        lint) cmd_lint "$@" ;;
        format) cmd_format "$@" ;;
        help|--help|-h) show_help ;;
        *) echo "${RED}Error: Unknown command '$COMMAND'${NC}"; echo; show_help; exit 1 ;;
    esac
}

main "$@"

